uv run main_4h_dynamic.py --dynamic
============================================================
  4時間足 動的リバランス実験 [ポイントインタイム動的銘柄]
  シナリオ比較: 0bps / 5bps / 15bps
============================================================

[Step 1] 4hデータ収集...

  動的ティッカー選定中...
  Bitget USDT-FUTURES ティッカー取得中...
  Bitget: 186 銘柄が出来高 > $1M
  Binance 上場確認中...
  Binance未上場 (73銘柄): 1000BONK, AAPL, ACU, AERO, AIO, AMZN, APP, ARC, ARM, AZTEC...
  最終: 113 銘柄を選定
  候補銘柄: 161 (固定101 ∪ 動的113)
  ヒストリカルデータ取得 (7624本 × 161銘柄)...
    20/161 銘柄取得完了
    40/161 銘柄取得完了
    60/161 銘柄取得完了
    80/161 銘柄取得完了
    100/161 銘柄取得完了
    120/161 銘柄取得完了
    140/161 銘柄取得完了
    160/161 銘柄取得完了
  3 銘柄が取得失敗
  158 銘柄 × 7624 本取得完了
  価格データ: 158 銘柄 × 7624 本

[Step 2] データ前処理...
  SP1: 91 銘柄 (出来高 > $1M @ 2023-02-06)
  SP1: 91 銘柄が利用可能
    訓練セット統計: mean=0.000192, std=0.020077
    訓練データ作成中...
    検証データ作成中...
    テストデータ作成中...
    テスト期間のバックテスト用データ作成中...
    サンプル数 - Train: 273000, Val: 81900, Test: 81343
    ラベル分布 - Train正例率: 0.506
    テスト期間: 900 日
  SP2: 97 銘柄 (出来高 > $1M @ 2023-07-06)
  SP2: 97 銘柄が利用可能
    訓練セット統計: mean=0.000341, std=0.020251
    訓練データ作成中...
    検証データ作成中...
    テストデータ作成中...
    テスト期間のバックテスト用データ作成中...
    サンプル数 - Train: 290925, Val: 86743, Test: 85741
    ラベル分布 - Train正例率: 0.506
    テスト期間: 900 日
  SP3: 104 銘柄 (出来高 > $1M @ 2023-12-03)
  SP3: 104 銘柄が利用可能
    訓練セット統計: mean=0.000139, std=0.023546
    訓練データ作成中...
    検証データ作成中...
    テストデータ作成中...
    テスト期間のバックテスト用データ作成中...
    サンプル数 - Train: 311443, Val: 92041, Test: 90913
    ラベル分布 - Train正例率: 0.501
    テスト期間: 900 日

[Step 3] 訓練・予測...

############################################################
  Study Period 1
  Test: 2024-11-17 ~ 2025-04-15
############################################################

  [1/3] ハイパーパラメータ探索...
    ユニット数 5 を検証中...
      検証精度: 0.5131
WARNING:tensorflow:From C:\Users\Utyujin\Dev\stock\stock_machine_learning\.venv\Lib\site-packages\keras\src\backend\common\global_state.py:82: The name tf.reset_default_graph is deprecated. Please use tf.compat.v1.reset_default_graph instead.

    ユニット数 10 を検証中...
      検証精度: 0.5131
    ユニット数 15 を検証中...
      検証精度: 0.5132
    ユニット数 20 を検証中...
      検証精度: 0.5133
    → 選択されたユニット数: 20 (検証精度: 0.5133)

  [2/3] アンサンブル訓練 (ユニット数=20)...
    アンサンブルモデル 1/10 (seed=7)
      検証精度: 0.5137
    アンサンブルモデル 2/10 (seed=49)
      検証精度: 0.5127
    アンサンブルモデル 3/10 (seed=91)
      検証精度: 0.5145
    アンサンブルモデル 4/10 (seed=133)
      検証精度: 0.5136
    アンサンブルモデル 5/10 (seed=175)
      検証精度: 0.5132
    アンサンブルモデル 6/10 (seed=217)
      検証精度: 0.5134
    アンサンブルモデル 7/10 (seed=259)
      検証精度: 0.5150
    アンサンブルモデル 8/10 (seed=301)
      検証精度: 0.5132
    アンサンブルモデル 9/10 (seed=343)
      検証精度: 0.5127
    アンサンブルモデル 10/10 (seed=385)
      検証精度: 0.5129

  [3/3] テスト期間の予測...
WARNING:tensorflow:5 out of the last 7 calls to <function TensorFlowTrainer.make_predict_function.<locals>.one_step_on_data_distributed at 0x000002C9CCA29D00> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
WARNING:tensorflow:6 out of the last 9 calls to <function TensorFlowTrainer.make_predict_function.<locals>.one_step_on_data_distributed at 0x000002C9CCA29D00> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
    予測完了: 900 期間分

############################################################
  Study Period 2
  Test: 2025-04-16 ~ 2025-09-12
############################################################

  [1/3] ハイパーパラメータ探索...
    ユニット数 5 を検証中...
      検証精度: 0.5166
    ユニット数 10 を検証中...
      検証精度: 0.5152
    ユニット数 15 を検証中...
      検証精度: 0.5171
    ユニット数 20 を検証中...
      検証精度: 0.5155
    → 選択されたユニット数: 15 (検証精度: 0.5171)

  [2/3] アンサンブル訓練 (ユニット数=15)...
    アンサンブルモデル 1/10 (seed=7)
      検証精度: 0.5154
    アンサンブルモデル 2/10 (seed=49)
      検証精度: 0.5160
    アンサンブルモデル 3/10 (seed=91)
      検証精度: 0.5170
    アンサンブルモデル 4/10 (seed=133)
      検証精度: 0.5172
    アンサンブルモデル 5/10 (seed=175)
      検証精度: 0.5159
    アンサンブルモデル 6/10 (seed=217)
      検証精度: 0.5155
    アンサンブルモデル 7/10 (seed=259)
      検証精度: 0.5170
    アンサンブルモデル 8/10 (seed=301)
      検証精度: 0.5174
    アンサンブルモデル 9/10 (seed=343)
      検証精度: 0.5164
    アンサンブルモデル 10/10 (seed=385)
      検証精度: 0.5176

  [3/3] テスト期間の予測...
    予測完了: 900 期間分

############################################################
  Study Period 3
  Test: 2025-09-13 ~ 2026-02-09
############################################################

  [1/3] ハイパーパラメータ探索...
    ユニット数 5 を検証中...
      検証精度: 0.5161
    ユニット数 10 を検証中...
      検証精度: 0.5175
    ユニット数 15 を検証中...
      検証精度: 0.5167
    ユニット数 20 を検証中...
      検証精度: 0.5168
    → 選択されたユニット数: 10 (検証精度: 0.5175)

  [2/3] アンサンブル訓練 (ユニット数=10)...
    アンサンブルモデル 1/10 (seed=7)
      検証精度: 0.5160
    アンサンブルモデル 2/10 (seed=49)
      検証精度: 0.5138
    アンサンブルモデル 3/10 (seed=91)
      検証精度: 0.5134
    アンサンブルモデル 4/10 (seed=133)
      検証精度: 0.5151
    アンサンブルモデル 5/10 (seed=175)
      検証精度: 0.5158
    アンサンブルモデル 6/10 (seed=217)
      検証精度: 0.5145
    アンサンブルモデル 7/10 (seed=259)
      検証精度: 0.5143
    アンサンブルモデル 8/10 (seed=301)
      検証精度: 0.5165
    アンサンブルモデル 9/10 (seed=343)
      検証精度: 0.5157
    アンサンブルモデル 10/10 (seed=385)
      検証精度: 0.5157

  [3/3] テスト期間の予測...
    予測完了: 900 期間分

============================================================
  シナリオ別バックテスト [ポイントインタイム動的銘柄]
============================================================

──────────────────────────────────────────────────
  シナリオ: 0bps + 動的リバランス
──────────────────────────────────────────────────

  SP1 バックテスト (0bps + 動的リバランス)...
    平均ターンオーバー: 4.0/10 銘柄/期間

==================================================
  パフォーマンス評価: SP1 0bps + 動的リバランス
==================================================
  日次平均リターン:     0.00078
  日次標準偏差:         0.01780
  VaR 1%:              -0.05789
  VaR 5%:              -0.02854
  CVaR 1%:             -0.07621
  CVaR 5%:             -0.04648
  年率ボラティリティ:   0.83279
  シャープレシオ:       2.0612
  ソルティノレシオ:     2.4401
  最大ドローダウン:     -0.4815
  精度:                 0.5556
  総リターン:           0.7528
==================================================

  SP2 バックテスト (0bps + 動的リバランス)...
    平均ターンオーバー: 4.3/10 銘柄/期間

==================================================
  パフォーマンス評価: SP2 0bps + 動的リバランス
==================================================
  日次平均リターン:     0.00064
  日次標準偏差:         0.01499
  VaR 1%:              -0.04745
  VaR 5%:              -0.02392
  CVaR 1%:             -0.06408
  CVaR 5%:             -0.03940
  年率ボラティリティ:   0.70136
  シャープレシオ:       2.0057
  ソルティノレシオ:     2.3666
  最大ドローダウン:     -0.2926
  精度:                 0.5601
  総リターン:           0.6096
==================================================

  SP3 バックテスト (0bps + 動的リバランス)...
    平均ターンオーバー: 3.4/10 銘柄/期間

==================================================
  パフォーマンス評価: SP3 0bps + 動的リバランス
==================================================
  日次平均リターン:     -0.00016
  日次標準偏差:         0.02010
  VaR 1%:              -0.06715
  VaR 5%:              -0.03355
  CVaR 1%:             -0.09078
  CVaR 5%:             -0.05580
  年率ボラティリティ:   0.94076
  シャープレシオ:       -0.3650
  ソルティノレシオ:     -0.4166
  最大ドローダウン:     -0.7548
  精度:                 0.5559
  総リターン:           -0.2782
==================================================

==================================================
  パフォーマンス評価: 全期間 0bps + 動的リバランス
==================================================
  日次平均リターン:     0.00042
  日次標準偏差:         0.01775
  VaR 1%:              -0.06113
  VaR 5%:              -0.02857
  CVaR 1%:             -0.07942
  CVaR 5%:             -0.04755
  年率ボラティリティ:   0.83068
  シャープレシオ:       1.1155
  ソルティノレシオ:     1.2897
  最大ドローダウン:     -0.7548
  精度:                 0.5572
  総リターン:           1.0366
==================================================

──────────────────────────────────────────────────
  シナリオ: 5bps + 動的リバランス
──────────────────────────────────────────────────

  SP1 バックテスト (5bps + 動的リバランス)...
    平均ターンオーバー: 4.0/10 銘柄/期間

==================================================
  パフォーマンス評価: SP1 5bps + 動的リバランス
==================================================
  日次平均リターン:     0.00039
  日次標準偏差:         0.01779
  VaR 1%:              -0.05849
  VaR 5%:              -0.02877
  CVaR 1%:             -0.07655
  CVaR 5%:             -0.04685
  年率ボラティリティ:   0.83264
  シャープレシオ:       1.0191
  ソルティノレシオ:     1.2108
  最大ドローダウン:     -0.4958
  精度:                 0.5556
  総リターン:           0.2271
==================================================

  SP2 バックテスト (5bps + 動的リバランス)...
    平均ターンオーバー: 4.3/10 銘柄/期間

==================================================
  パフォーマンス評価: SP2 5bps + 動的リバランス
==================================================
  日次平均リターン:     0.00021
  日次標準偏差:         0.01499
  VaR 1%:              -0.04795
  VaR 5%:              -0.02422
  CVaR 1%:             -0.06441
  CVaR 5%:             -0.03980
  年率ボラティリティ:   0.70144
  シャープレシオ:       0.6546
  ソルティノレシオ:     0.7746
  最大ドローダウン:     -0.3089
  精度:                 0.5601
  総リターン:           0.0905
==================================================

  SP3 バックテスト (5bps + 動的リバランス)...
    平均ターンオーバー: 3.4/10 銘柄/期間

==================================================
  パフォーマンス評価: SP3 5bps + 動的リバランス
==================================================
  日次平均リターン:     -0.00050
  日次標準偏差:         0.02009
  VaR 1%:              -0.06755
  VaR 5%:              -0.03386
  CVaR 1%:             -0.09105
  CVaR 5%:             -0.05610
  年率ボラティリティ:   0.94039
  シャープレシオ:       -1.1616
  ソルティノレシオ:     -1.3279
  最大ドローダウン:     -0.7781
  精度:                 0.5559
  総リターン:           -0.4694
==================================================

==================================================
  パフォーマンス評価: 全期間 5bps + 動的リバランス
==================================================
  日次平均リターン:     0.00003
  日次標準偏差:         0.01775
  VaR 1%:              -0.06133
  VaR 5%:              -0.02902
  CVaR 1%:             -0.07973
  CVaR 5%:             -0.04790
  年率ボラティリティ:   0.83048
  シャープレシオ:       0.0865
  ソルティノレシオ:     0.1003
  最大ドローダウン:     -0.7866
  精度:                 0.5572
  総リターン:           -0.2900
==================================================

──────────────────────────────────────────────────
  シナリオ: 15bps フルターンオーバー
──────────────────────────────────────────────────

  SP1 バックテスト (15bps フルターンオーバー)...

==================================================
  パフォーマンス評価: SP1 15bps フルターンオーバー
==================================================
  日次平均リターン:     -0.00236
  日次標準偏差:         0.01853
  VaR 1%:              -0.06211
  VaR 5%:              -0.03317
  CVaR 1%:             -0.08434
  CVaR 5%:             -0.04978
  年率ボラティリティ:   0.86730
  シャープレシオ:       -5.9677
  ソルティノレシオ:     -7.4017
  最大ドローダウン:     -0.9151
  精度:                 0.5538
  総リターン:           -0.8984
==================================================

  SP2 バックテスト (15bps フルターンオーバー)...

==================================================
  パフォーマンス評価: SP2 15bps フルターンオーバー
==================================================
  日次平均リターン:     -0.00234
  日次標準偏差:         0.01622
  VaR 1%:              -0.05890
  VaR 5%:              -0.03055
  CVaR 1%:             -0.06919
  CVaR 5%:             -0.04647
  年率ボラティリティ:   0.75913
  シャープレシオ:       -6.7483
  ソルティノレシオ:     -7.8897
  最大ドローダウン:     -0.8913
  精度:                 0.5599
  総リターン:           -0.8923
==================================================

  SP3 バックテスト (15bps フルターンオーバー)...

==================================================
  パフォーマンス評価: SP3 15bps フルターンオーバー
==================================================
  日次平均リターン:     -0.00301
  日次標準偏差:         0.02242
  VaR 1%:              -0.08159
  VaR 5%:              -0.04177
  CVaR 1%:             -0.09670
  CVaR 5%:             -0.06529
  年率ボラティリティ:   1.04897
  シャープレシオ:       -6.2862
  ソルティノレシオ:     -7.2361
  最大ドローダウン:     -0.9488
  精度:                 0.5580
  総リターン:           -0.9474
==================================================

==================================================
  パフォーマンス評価: 全期間 15bps フルターンオーバー
==================================================
  日次平均リターン:     -0.00257
  日次標準偏差:         0.01922
  VaR 1%:              -0.06868
  VaR 5%:              -0.03489
  CVaR 1%:             -0.08652
  CVaR 5%:             -0.05460
  年率ボラティリティ:   0.89957
  シャープレシオ:       -6.2595
  ソルティノレシオ:     -7.3519
  最大ドローダウン:     -0.9995
  精度:                 0.5572
  総リターン:           -0.9994
==================================================

============================================================
  シナリオ比較サマリー [ポイントインタイム動的銘柄]
============================================================

  シナリオ                        Sharpe       精度      総リターン     最大DD
  ────────────────────────────────────────────────────────────
  0bps + 動的リバランス                1.12   55.7%    103.7%  -75.5%
  5bps + 動的リバランス                0.09   55.7%    -29.0%  -78.7%
  15bps フルターンオーバー              -6.26   55.7%    -99.9% -100.0%
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 21205 (\N{CJK UNIFIED IDEOGRAPH-52D5}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 30340 (\N{CJK UNIFIED IDEOGRAPH-7684}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12522 (\N{KATAKANA LETTER RI}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12496 (\N{KATAKANA LETTER BA}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12521 (\N{KATAKANA LETTER RA}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12531 (\N{KATAKANA LETTER N}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12473 (\N{KATAKANA LETTER SU}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12501 (\N{KATAKANA LETTER HU}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12523 (\N{KATAKANA LETTER RU}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12479 (\N{KATAKANA LETTER TA}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12540 (\N{KATAKANA-HIRAGANA PROLONGED SOUND MARK}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:158: UserWarning: Glyph 12458 (\N{KATAKANA LETTER O}) missing from font(s) DejaVu Sans.
  plt.tight_layout()
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 21205 (\N{CJK UNIFIED IDEOGRAPH-52D5}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 30340 (\N{CJK UNIFIED IDEOGRAPH-7684}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12522 (\N{KATAKANA LETTER RI}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12496 (\N{KATAKANA LETTER BA}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12521 (\N{KATAKANA LETTER RA}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12531 (\N{KATAKANA LETTER N}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12473 (\N{KATAKANA LETTER SU}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12501 (\N{KATAKANA LETTER HU}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12523 (\N{KATAKANA LETTER RU}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12479 (\N{KATAKANA LETTER TA}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12540 (\N{KATAKANA-HIRAGANA PROLONGED SOUND MARK}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)
C:\Users\Utyujin\Dev\stock\stock_machine_learning\main_4h_dynamic.py:160: UserWarning: Glyph 12458 (\N{KATAKANA LETTER O}) missing from font(s) DejaVu Sans.
  plt.savefig(fig_path, dpi=150)

比較グラフ保存: C:\Users\Utyujin\Dev\stock\stock_machine_learning\output_4h_dynamic_dynamic_tickers\scenario_comparison.png

完了!
